"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[40484],{35318:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>g});var r=n(27378);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),l=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=l(e.components);return r.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),u=l(n),g=a,d=u["".concat(s,".").concat(g)]||u[g]||m[g]||i;return n?r.createElement(d,o(o({ref:t},c),{},{components:n})):r.createElement(d,o({ref:t},c))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=u;var p={};for(var s in t)hasOwnProperty.call(t,s)&&(p[s]=t[s]);p.originalType=e,p.mdxType="string"==typeof e?e:a,o[1]=p;for(var l=2;l<i;l++)o[l]=n[l];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},11574:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>f,contentTitle:()=>g,default:()=>y,frontMatter:()=>u,metadata:()=>d,toc:()=>k});var r=n(35318),a=Object.defineProperty,i=Object.defineProperties,o=Object.getOwnPropertyDescriptors,p=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,c=(e,t,n)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,m=(e,t)=>{for(var n in t||(t={}))s.call(t,n)&&c(e,n,t[n]);if(p)for(var n of p(t))l.call(t,n)&&c(e,n,t[n]);return e};const u={},g=void 0,d={unversionedId:"coding/nextjs-best-practice",id:"coding/nextjs-best-practice",title:"nextjs-best-practice",description:"- rate-limiter",source:"@site/my-documents/docs/coding/nextjs-best-practice.md",sourceDirName:"coding",slug:"/coding/nextjs-best-practice",permalink:"/docs/coding/nextjs-best-practice",draft:!1,editUrl:"https://github.com/markshawn2020/docusaurus/edit/master/my-documents/docs/coding/nextjs-best-practice.md",tags:[],version:"current",lastUpdatedAt:1708971274,formattedLastUpdatedAt:"2024\u5e742\u670826\u65e5",frontMatter:{},sidebar:"defaultSidebar",previous:{title:"next-themes",permalink:"/docs/coding/next-themes"},next:{title:"nextjs",permalink:"/docs/coding/nextjs"}},f={},k=[],h={toc:k};function y(e){var t,n=e,{components:a}=n,c=((e,t)=>{var n={};for(var r in e)s.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&p)for(var r of p(e))t.indexOf(r)<0&&l.call(e,r)&&(n[r]=e[r]);return n})(n,["components"]);return(0,r.kt)("wrapper",(t=m(m({},h),c),i(t,o({components:a,mdxType:"MDXLayout"}))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"rate-limiter",(0,r.kt)("h2",m({parentName:"li"},{id:"collapsed-true"}),"collapsed:: true"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"packages"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"rate-limit-redis - npm, ",(0,r.kt)("a",m({parentName:"li"},{href:"https://www.npmjs.com/package/rate-limit-redis"}),"https://www.npmjs.com/package/rate-limit-redis")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",m({parentName:"pre"},{className:"language-ts"}),'  /**\n   * 2. \u68c0\u67e5\u9891\u7387\u7b49\u76f8\u5173\n   * note:\n   *  1. \u56e0\u4e3a\u6211\u4eec\u5df2\u7ecf\u6709\u4e86\u7528\u6237\u7cfb\u7edf\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u68c0\u67e5\u9891\u7387\u4e86\n   *  2. \u8fd9\u4e2a\u57fa\u4e8e KV \u7684\u5bf9\u4e8e\u5927\u9646\u6765\u8bf4\uff0c\u592a\u6162\u4e86\uff0c\u771f\u8981\u505a\uff0c\u53ef\u4ee5\u4f7f\u7528\u672c\u5730\u7684 redis\uff0c\u53c2\u8003\uff1arate-limit-redis - npm, https://www.npmjs.com/package/rate-limit-redis\n   */\n  if (baseEnv.KV_REST_API_URL && baseEnv.KV_REST_API_TOKEN) {\n    const ip = req.headers.get("x-forwarded-for")\n    const ratelimit = new Ratelimit({\n      redis: kv,\n      // rate limit to 1 requests per 20 seconds\n      limiter: Ratelimit.slidingWindow(3, "10s"),\n    })\n\n    const { success, limit, reset, remaining } = await ratelimit.limit(`ratelimit_${ip}`)\n\n    if (!success) {\n      return NextResponse.json("\u60a8\u7684\u901f\u5ea6\u592a\u5feb\u5566\uff0c\u8bf7\u6162\u70b9\uff01", {\n        status: 429,\n        headers: {\n          "X-RateLimit-Limit": limit.toString(),\n          "X-RateLimit-Remaining": remaining.toString(),\n          "X-RateLimit-Reset": reset.toString(),\n        },\n      })\n    }\n    console.log("passed rate limiter")\n  }\n'))))),(0,r.kt)("li",{parentName:"ul"},"openai streaming",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"version management"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u6559\u8bad\uff1a\u6240\u4ee5\u63a5\u7b2c\u4e09\u65b9\u5e93\u771f\u5730\u8fd8\u662f\u8c28\u614e\uff0c\u5c31\u7b97vercel\u8fd9\u79cd\u516c\u53f8\u7684\u7b2c\u4e09\u65b9\u5e93\uff0c\u4e5f\u53ef\u80fd\u6709bug\uff0c\u6216\u8005\u4e0d\u6ee1\u8db3\u9700\u6c42\uff0cvercel\u7684sdk\u91cc\u662f\u4e00\u80a1\u8111\u585emessages\u7ed9\u540e\u7aef\uff0c\u4f46\u8fd9\u6837\u4e0d\u4f46\u6027\u80fd\u4f4e\uff0c\u800c\u4e14\u7075\u6d3b\u6027\u4e5f\u4e0d\u591f\uff0c\u770bchatgpt\u7684\u524d\u7aef\u5b9e\u73b0\uff0c\u80af\u5b9a\u662f\u8981\u7ef4\u62a4\u4e00\u4e2aconversation\u7684\uff0c\u8fd9\u6837\u53ef\u4ee5\u589e\u91cf\u4ea4\u4e92\uff0c\u4e0d\u8fc7chatgpt\u4e5f\u9e21\u8d3c\uff0c\u5b83\u7684\u7f51\u9875\u8bbf\u95ee\u901f\u5ea6\u90a3\u4e48\u5feb\uff0c\u9664\u4e86\u57fa\u4e8eedge\u4e4b\u5916\uff0c\u6211\u731c\u5c31\u662f\u505a\u4e86\u66b4\u529b\u7684rolling window\uff0c\u4e0d\u7136\u5f97\u6570\u636e\u5e93\u4ea4\u4e92\uff0c\u5c31\u53d8\u6162\u4e86"),(0,r.kt)("li",{parentName:"ul"},"at the beginning\n",(0,r.kt)("img",m({parentName:"li"},{src:"https://poketto.oss-cn-hangzhou.aliyuncs.com/image_1693667840442_0.png",alt:"image.png"}))),(0,r.kt)("li",{parentName:"ul"},"after ",(0,r.kt)("inlineCode",{parentName:"li"}," yarn add langchain@latest"),(0,r.kt)("img",m({parentName:"li"},{src:"https://poketto.oss-cn-hangzhou.aliyuncs.com/image_1693667872670_0.png",alt:"image.png"}))),(0,r.kt)("li",{parentName:"ul"},"after ",(0,r.kt)("inlineCode",{parentName:"li"},"yarn add ai@latest"),(0,r.kt)("img",m({parentName:"li"},{src:"https://poketto.oss-cn-hangzhou.aliyuncs.com/image_1693667893080_0.png",alt:"image.png"}))),(0,r.kt)("li",{parentName:"ul"}),(0,r.kt)("li",{parentName:"ul"}))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",m({parentName:"pre"},{className:"language-ts"}),"import OpenAI from 'openai'\n\n// nodejs + edge\n\nconst response = await new OpenAI({\n      apiKey: baseEnv.OPENAI_API_KEY,\n      timeout: 3000,\n      /**\n       *\n       * ref:\n       *  - https://github.com/openai/openai-node/tree/v4#configuring-an-https-agent-eg-for-proxies\n       *  - https://github.com/openai/openai-node/issues/85\n       *  - https://www.npmjs.com/package/https-proxy-agent\n       *\n       * edge \u73af\u5883\u4e2d \u4e0d\u652f\u6301 http / https-proxy-agent \u7b49\u5e93\n       *\n       * \u5927\u9646\u670d\u52a1\u5668\u9700\u8981\u5f00\u542f clash tun mode !\n       */\n      httpAgent: undefined,\n    }).chat.completions.create({\n      model: modelType,\n      stream: true,\n      messages,\n      temperature: 0.7,\n    })\n"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",m({parentName:"p"},{src:"https://poketto.oss-cn-hangzhou.aliyuncs.com/image_1693667033047_0.png",alt:"image.png"})))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",m({parentName:"p"},{href:"https://sdk.vercel.ai/docs/api-reference/openai-stream"}),"https://sdk.vercel.ai/docs/api-reference/openai-stream"),"\n",(0,r.kt)("img",m({parentName:"p"},{src:"https://poketto.oss-cn-hangzhou.aliyuncs.com/image_1693667066209_0.png",alt:"image.png"})))),(0,r.kt)("li",{parentName:"ul"})))))}y.isMDXComponent=!0}}]);