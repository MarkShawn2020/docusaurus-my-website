"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[14568],{35318:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var r=n(27378);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=p(n),u=a,h=c["".concat(l,".").concat(u)]||c[u]||m[u]||o;return n?r.createElement(h,i(i({ref:t},d),{},{components:n})):r.createElement(h,i({ref:t},d))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}c.displayName="MDXCreateElement"},24270:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>f,contentTitle:()=>u,default:()=>k,frontMatter:()=>c,metadata:()=>h,toc:()=>b});var r=n(35318),a=Object.defineProperty,o=Object.defineProperties,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,d=(e,t,n)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,m=(e,t)=>{for(var n in t||(t={}))l.call(t,n)&&d(e,n,t[n]);if(s)for(var n of s(t))p.call(t,n)&&d(e,n,t[n]);return e};const c={},u=void 0,h={unversionedId:"coding/Languages/JS/database",id:"coding/Languages/JS/database",title:"database",description:"1. typeorm join table",source:"@site/my-documents/docs/coding/Languages/JS/database.md",sourceDirName:"coding/Languages/JS",slug:"/coding/Languages/JS/database",permalink:"/docs/coding/Languages/JS/database",draft:!1,editUrl:"https://github.com/markshawn2020/docusaurus/edit/master/my-documents/docs/coding/Languages/JS/database.md",tags:[],version:"current",lastUpdatedAt:1726564669,formattedLastUpdatedAt:"2024\u5e749\u670817\u65e5",frontMatter:{},sidebar:"defaultSidebar",previous:{title:"Vue howto",permalink:"/docs/coding/Languages/JS/Vue/vue-howto"},next:{title:"develop-remark-plugin",permalink:"/docs/coding/Languages/JS/develop-remark-plugin"}},f={},b=[{value:"typeorm join table",id:"typeorm-join-table",level:2},{value:"\u2705 join using id(string) other than Entity",id:"-join-using-idstring-other-than-entity",level:3},{value:"\u274c join return flatted list other than nested",id:"-join-return-flatted-list-other-than-nested",level:3},{value:"typeorm not null constraint failed",id:"typeorm-not-null-constraint-failed",level:2},{value:"PASS: better-sqlite3 <code>NODE_MODULE_VERSION</code> mismatch | rebuild failed",id:"pass-better-sqlite3-node_module_version-mismatch--rebuild-failed",level:2},{value:"PASS: better-sqlite3 ReferenceError: better_sqlite3_1 is not defined, both <code>jest</code> and <code>mocha</code>",id:"pass-better-sqlite3-referenceerror-better_sqlite3_1-is-not-defined-both-jest-and-mocha",level:2},{value:"mocha + ts + esm",id:"mocha--ts--esm",level:3}],y={toc:b};function k(e){var t,n=e,{components:a}=n,d=((e,t)=>{var n={};for(var r in e)l.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&s)for(var r of s(e))t.indexOf(r)<0&&p.call(e,r)&&(n[r]=e[r]);return n})(n,["components"]);return(0,r.kt)("wrapper",(t=m(m({},y),d),o(t,i({components:a,mdxType:"MDXLayout"}))),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",m({parentName:"li"},{href:"#typeorm-join-table"}),"typeorm join table")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",m({parentName:"li"},{href:"#white_check_mark-join-using-idstring-other-than-entity"}),"\u2705 join using id(string) other than Entity")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",m({parentName:"li"},{href:"#x-join-return-flatted-list-other-than-nested"}),"\u274c join return flatted list other than nested")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",m({parentName:"li"},{href:"#typeorm-not-null-constraint-failed"}),"typeorm not null constraint failed")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",m({parentName:"li"},{href:"#pass--better-sqlite3-node_module_version-mismatch--rebuild-failed"}),"PASS: better-sqlite3 ",(0,r.kt)("inlineCode",{parentName:"a"},"NODE_MODULE_VERSION")," mismatch | rebuild failed")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",m({parentName:"li"},{href:"#pass-better-sqlite3-referenceerror-better_sqlite3_1-is-not-defined-both-jest-and-mocha"}),"PASS: better-sqlite3 ReferenceError: better_sqlite3_1 is not defined, both ",(0,r.kt)("inlineCode",{parentName:"a"},"jest")," and ",(0,r.kt)("inlineCode",{parentName:"a"},"mocha"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",m({parentName:"li"},{href:"#mocha--ts--esm"}),"mocha + ts + esm"))),(0,r.kt)("h2",m({},{id:"typeorm-join-table"}),"typeorm join table"),(0,r.kt)("h3",m({},{id:"-join-using-idstring-other-than-entity"}),"\u2705 join using id(string) other than Entity"),(0,r.kt)("p",null,"I have checked a lot of typeorm documentation and relative discussion, but to find they all use an extra column to specify the table to join."),(0,r.kt)("p",null,"For example, int the case below, the key of ",(0,r.kt)("inlineCode",{parentName:"p"},"user")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"Profile")," refers to ",(0,r.kt)("inlineCode",{parentName:"p"},"User"),", and the key of ",(0,r.kt)("inlineCode",{parentName:"p"},"profile")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"User")," refers to ",(0,r.kt)("inlineCode",{parentName:"p"},"Profile"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",m({parentName:"pre"},{className:"language-ts"}),'# Entity Profile\nimport {Entity, PrimaryGeneratedColumn, Column, OneToOne} from "typeorm";\nimport {User} from "./User";\n\n@Entity()\nexport class Profile {\n\n    @PrimaryGeneratedColumn()\n    id: number;\n\n    @Column()\n    gender: string;\n\n    @Column()\n    photo: string;\n\n    @OneToOne(() => User, user => user.profile) // specify inverse side as a second parameter\n    user: User;\n\n}\n\n# Entity User\nimport {Entity, PrimaryGeneratedColumn, Column, OneToOne, JoinColumn} from "typeorm";\nimport {Profile} from "./Profile";\n\n@Entity()\nexport class User {\n\n    @PrimaryGeneratedColumn()\n    id: number;\n\n    @Column()\n    name: string;\n\n    @OneToOne(() => Profile, profile => profile.user) // specify inverse side as a second parameter\n    @JoinColumn()\n    profile: Profile;\n\n}\n')),(0,r.kt)("p",null,"However, in my own business scene, since I have two tables with the equal level and the same ",(0,r.kt)("inlineCode",{parentName:"p"},"id")," property, it's redundant for me to specify an extra column named as ",(0,r.kt)("inlineCode",{parentName:"p"},"erpId")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"trdId")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"foreignId")," or anything."),(0,r.kt)("p",null,"Besides, since the ",(0,r.kt)("inlineCode",{parentName:"p"},"trd")," and the ",(0,r.kt)("inlineCode",{parentName:"p"},"erp")," are saved into db not synchronously, the example listed on the documentation won't help to us."),(0,r.kt)("p",null,"Through my hard experiment and observation, I finally realized the join key is some kind of ",(0,r.kt)("inlineCode",{parentName:"p"},"id")," (not real object) which means if only I specified the correct id, the join action then would be executed successfully."),(0,r.kt)("p",null,"That's it! Since we have already know the id of item to be join, which is directly the id of the item itself, then we can just let the id to be the joined key, like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",m({parentName:"pre"},{className:"language-ts"}),"# Entity Erp\nimport { Column, Entity, OneToOne, PrimaryColumn } from 'typeorm';\nimport { TrdModel } from './trd';\n\n@Entity()\nexport class ErpModel {\n\n  @OneToOne(() => TrdModel, trd => trd.id)\n  @PrimaryColumn()\n  id: string;\n\n}\n\n# Entity Trd\nimport { Column, Entity, JoinColumn, OneToOne, PrimaryColumn } from 'typeorm';\nimport { ErpModel } from './erp';\n\n@Entity()\nexport class TrdModel  {\n  @OneToOne(() => ErpModel, erp=>erp.id )\n  @JoinColumn()\n  @PrimaryColumn()\n  id: string;\n}\n")),(0,r.kt)("p",null,"So I can use the following query to get a joined table:"),(0,r.kt)("pre",null,(0,r.kt)("code",m({parentName:"pre"},{className:"language-ts"}),"// src/main/modules/queryDB/db.ts:40\n// map erp into `id`, so `id` would go away\n      getConnection()\n        .leftJoinAndSelect('trd.id', 'erp')\n        .skip(skip)\n        .limit(limit)\n        .getMany()\n    );\n")),(0,r.kt)("img",{alt:"picture 3",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/database-1641883942426-5cfef08aace698977502e57644e78e6c3b45ccbc34d76978642b5337ff4068fa.png"}),(0,r.kt)("pre",null,(0,r.kt)("code",m({parentName:"pre"},{className:"language-ts"}),"// map erp into `erp`, so `id` still existed\n      getConnection()\n        .manager.createQueryBuilder(TrdModel, 'trd')\n        .leftJoinAndMapOne('trd.erp', ErpModel, 'erp', 'erp.id = trd.id')\n        .skip(skip)\n        .limit(limit)\n        .getMany()\n    );\n")),(0,r.kt)("img",{alt:"picture 6",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/database-1641894903691-ecc5ca26d8438b8c4283055900d4d6e9680338e15d531190c167d64be121d66e.png"}),(0,r.kt)("p",null,"ref:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",m({parentName:"p"},{href:"https://typeorm.io/#/one-to-one-relations"}),"TypeORM - Amazing ORM for TypeScript and JavaScript (ES7, ES6, ES5). Supports MySQL, PostgreSQL, MariaDB, SQLite, MS SQL Server, Oracle, WebSQL databases. Works in NodeJS, Browser, Ionic, Cordova and Electron platforms."))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",m({parentName:"p"},{href:"https://orkhan.gitbook.io/typeorm/docs/one-to-one-relations"}),"One-to-one relations - typeorm"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",m({parentName:"p"},{href:"https://www.porschebz.com/posts/42345.html"}),"NestJs \u4e2d\u4f7f\u7528 Typeorm \u7684\u95ee\u9898\u603b\u7ed3 | Porschebz")))),(0,r.kt)("h3",m({},{id:"-join-return-flatted-list-other-than-nested"}),"\u274c join return flatted list other than nested"),(0,r.kt)("p",null,"It's sad to find that it is impossible in typeorm, which reminds me the beauty of ",(0,r.kt)("inlineCode",{parentName:"p"},"pandas"),", lol."),(0,r.kt)("img",{alt:"picture 4",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/database-1641893492395-6a822246d22301f3fa6974058a567a005a69e234dc94da55a46c5b4d4a724ebb.png"}),(0,r.kt)("p",null,"So I should manually add one ",(0,r.kt)("inlineCode",{parentName:"p"},"map")," to help finish this conversion."),(0,r.kt)("p",null,"ref: I spent a lot of time and finally thought of the search key of ",(0,r.kt)("inlineCode",{parentName:"p"},"flat"),"!"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",m({parentName:"li"},{href:"https://github.com/typeorm/typeorm/issues/5111"}),"How to return a relation column as top level in response? \xb7 Issue #5111 \xb7 typeorm/typeorm"))),(0,r.kt)("h2",m({},{id:"typeorm-not-null-constraint-failed"}),"typeorm not null constraint failed"),(0,r.kt)("p",null,"This is because I added new table columns into former model."),(0,r.kt)("img",{alt:"picture 41",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/database-1641652378702-4275729e537afcacf2683f64ef62d2a483273f6bccf4bf5933ccb490b4abc8e9.png"}),(0,r.kt)("p",null,"Since I do not know the ",(0,r.kt)("inlineCode",{parentName:"p"},"source")," is , or unnecessary, I would like to delete the table first."),(0,r.kt)("p",null,"I tried to delete table but not found the choice but the ",(0,r.kt)("inlineCode",{parentName:"p"},"dropDatabase()"),". ",(0,r.kt)("img",{alt:"picture 42",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/database-1641653005035-a9fb5d2adc9a4fd9188e9a5dee06581a59f5a084bcd29764250b5a5cd1bbef0e.png"})),(0,r.kt)("h2",m({},{id:"pass-better-sqlite3-node_module_version-mismatch--rebuild-failed"}),"PASS: better-sqlite3 ",(0,r.kt)("inlineCode",{parentName:"h2"},"NODE_MODULE_VERSION")," mismatch | rebuild failed"),(0,r.kt)("img",{alt:"picture 12",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/best-sqlite3-1641545886362-5b85064baa519f5c06ecf28469b8462382162f0d792649670db6e0b1b3b77525.png"}),(0,r.kt)("img",{alt:"picture 13",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/best-sqlite3-1641546347572-29a1230b8941634376b03ed20a25c09b9fd917dd49de0a823f68df13042a6613.png"}),(0,r.kt)("h2",m({},{id:"pass-better-sqlite3-referenceerror-better_sqlite3_1-is-not-defined-both-jest-and-mocha"}),"PASS: better-sqlite3 ReferenceError: better_sqlite3_1 is not defined, both ",(0,r.kt)("inlineCode",{parentName:"h2"},"jest")," and ",(0,r.kt)("inlineCode",{parentName:"h2"},"mocha")),(0,r.kt)("p",null,"The author suggests us to use mocha: ",(0,r.kt)("a",m({parentName:"p"},{href:"https://github.com/JoshuaWise/better-sqlite3/issues/162#:~:text=A%20more%20robust%20testing%20framework%20(such%20as%20mocha%2C%20the%20one%20used%20in%20the%20better%2Dsqlite3%20repository)%2C%20does%20not%20cause%20such%20an%20issue."}),"A more robust testing framework (such as mocha, the one used in the better-sqlite3 repository), does not cause such an issue.")),(0,r.kt)("p",null,"ref:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",m({parentName:"li"},{href:"https://github.com/JoshuaWise/better-sqlite3/issues/162"}),"SqliteErrors have wrong constructor in Jest environment \xb7 Issue #162 \xb7 JoshuaWise/better-sqlite3"))),(0,r.kt)("h3",m({},{id:"mocha--ts--esm"}),"mocha + ts + esm"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",m({parentName:"li"},{href:"https://github.com/mochajs/mocha-examples/issues/47"}),"typescript with ts-node and ESM support \xb7 Issue #47 \xb7 mochajs/mocha-examples"))))}k.isMDXComponent=!0}}]);