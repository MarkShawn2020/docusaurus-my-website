"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[46269],{35318:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>m});var n=a(27378);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var i=n.createContext({}),p=function(e){var t=n.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(i.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(a),m=r,f=u["".concat(i,".").concat(m)]||u[m]||d[m]||o;return a?n.createElement(f,s(s({ref:t},c),{},{components:a})):n.createElement(f,s({ref:t},c))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,s=new Array(o);s[0]=u;var l={};for(var i in t)hasOwnProperty.call(t,i)&&(l[i]=t[i]);l.originalType=e,l.mdxType="string"==typeof e?e:r,s[1]=l;for(var p=2;p<o;p++)s[p]=a[p];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},58324:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>h,contentTitle:()=>m,default:()=>v,frontMatter:()=>u,metadata:()=>f,toc:()=>k});var n=a(35318),r=Object.defineProperty,o=Object.defineProperties,s=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,c=(e,t,a)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,d=(e,t)=>{for(var a in t||(t={}))i.call(t,a)&&c(e,a,t[a]);if(l)for(var a of l(t))p.call(t,a)&&c(e,a,t[a]);return e};const u={},m="js-howto",f={unversionedId:"coding/Languages/JS/js-howto",id:"coding/Languages/JS/js-howto",title:"js-howto",description:"BEST-PRACTICE: js parse float to int",source:"@site/my-documents/docs/coding/Languages/JS/js-howto.md",sourceDirName:"coding/Languages/JS",slug:"/coding/Languages/JS/js-howto",permalink:"/docs/coding/Languages/JS/js-howto",draft:!1,editUrl:"https://github.com/markshawn2020/docusaurus/edit/master/my-documents/docs/coding/Languages/JS/js-howto.md",tags:[],version:"current",lastUpdatedAt:1726564669,formattedLastUpdatedAt:"2024\u5e749\u670817\u65e5",frontMatter:{},sidebar:"defaultSidebar",previous:{title:"js discuss",permalink:"/docs/coding/Languages/JS/js-discuss"},next:{title:"npm/yarn bugfix",permalink:"/docs/coding/Languages/JS/npm_yarn-bugfix"}},h={},k=[{value:"BEST-PRACTICE: js parse float to int",id:"best-practice-js-parse-float-to-int",level:2},{value:"TODO: prettier plugin of <code>decorators</code>",id:"todo-prettier-plugin-of-decorators",level:2},{value:"jsdoc",id:"jsdoc",level:2},{value:"modify <code>process.env</code>",id:"modify-processenv",level:2},{value:"node exec sub commands",id:"node-exec-sub-commands",level:2},{value:"webpack",id:"webpack",level:2},{value:"receive arg from command line Standard Method (no library)",id:"receive-arg-from-command-line-standard-method-no-library",level:2},{value:"change string to number DON'T",id:"change-string-to-number-dont",level:2},{value:"best practice to use Exceptions",id:"best-practice-to-use-exceptions",level:2},{value:"catch error",id:"catch-error",level:3},{value:"extend error",id:"extend-error",level:3},{value:"HANDBOOK fs read file, async and part",id:"handbook-fs-read-file-async-and-part",level:2},{value:"csv read and parse",id:"csv-read-and-parse",level:2},{value:"modify header",id:"modify-header",level:3},{value:"then, what about repeatability?",id:"then-what-about-repeatability",level:4},{value:"<code>node-csv</code> or <code>fast-csv</code>",id:"node-csv-or-fast-csv",level:3},{value:"<code>fast-csv</code> problem of quotes",id:"fast-csv-problem-of-quotes",level:3},{value:"csv not closed",id:"csv-not-closed",level:3},{value:"run js in different envs",id:"run-js-in-different-envs",level:2},{value:"browser env",id:"browser-env",level:3},{value:"node env",id:"node-env",level:3},{value:"node + esm",id:"node--esm",level:3},{value:"node + esm + ts",id:"node--esm--ts",level:3},{value:"use <code>__filename</code> and <code>__dirname</code> in ESM",id:"use-__filename-and-__dirname-in-esm",level:2}],g={toc:k};function v(e){var t,a=e,{components:r}=a,c=((e,t)=>{var a={};for(var n in e)i.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&l)for(var n of l(e))t.indexOf(n)<0&&p.call(e,n)&&(a[n]=e[n]);return a})(a,["components"]);return(0,n.kt)("wrapper",(t=d(d({},g),c),o(t,s({components:r,mdxType:"MDXLayout"}))),(0,n.kt)("h1",d({},{id:"js-howto"}),"js-howto"),(0,n.kt)("h2",d({},{id:"best-practice-js-parse-float-to-int"}),"BEST-PRACTICE: js parse float to int"),(0,n.kt)("p",null,"ref:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",d({parentName:"li"},{href:"https://www.delftstack.com/howto/javascript/javascript-float-to-int/"}),"Convert a Float Number to Int in JavaScript | Delft Stack"))),(0,n.kt)("h2",d({},{id:"todo-prettier-plugin-of-decorators"}),"TODO: prettier plugin of ",(0,n.kt)("inlineCode",{parentName:"h2"},"decorators")),(0,n.kt)("p",null,"This experimental syntax requires enabling one of the following parser plugin(s): 'decorators-legacy, decorators' (9:0)"),(0,n.kt)("img",{alt:"picture 5",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/readme-1641894406039-133b59aa7e51366d78542af9a0cf0f91344d4a17eace2e1fed1bd0110d8ffa9c.png"}),(0,n.kt)("h2",d({},{id:"jsdoc"}),"jsdoc"),(0,n.kt)("p",null,"ref:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",d({parentName:"li"},{href:"https://alligator.io/js/jsdoc/"}),"Automate JavaScript API Documentation with JSDoc \u2190 Alligator.io"))),(0,n.kt)("h2",d({},{id:"modify-processenv"}),"modify ",(0,n.kt)("inlineCode",{parentName:"h2"},"process.env")),(0,n.kt)("p",null,"Here explained why the variable cannot change since it has been compiled into a const string. ",(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/52871895/cant-set-values-on-process-env-in-client-side-javascript"}),"environment variables - Can't set values on ",(0,n.kt)("inlineCode",{parentName:"a"},"process.env")," in client-side Javascript - Stack Overflow")," ",(0,n.kt)("img",{alt:"picture 1",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/js-howto-1641239508558-76650a9fe7ba3910d2a30f7ffee4b20c4f478b4e69518fe537a4806cd349202a.png",width:"480"})),(0,n.kt)("p",null,"And here's also the same problem but caused ",(0,n.kt)("inlineCode",{parentName:"p"},"terser")," plugin not work: ",(0,n.kt)("a",d({parentName:"p"},{href:"https://github.com/terser/terser/issues/736"}),"Error happened when processing on the assignment statement of 'process.env'. \xb7 Issue #736 \xb7 terser/terser")),(0,n.kt)("img",{alt:"picture 2",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/js-howto-1641239575492-9178f1c0c29d71302c0179c03bf7d72589ae8380c864297ae8ad99357c4afa95.png",width:"480"}),(0,n.kt)("img",{alt:"picture 3",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/js-howto-1641239637983-fabb9d225b44656dfda1119765d0ff09d43a2ea4aa9a3e84870be74c6b723dcc.png",width:"480"}),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",d({parentName:"li"},{href:"https://github.com/webpack/webpack/issues/12444"}),"Handling process.env.SOME_UNDEFINED_KEY as undefined with DefinePlugin \xb7 Issue #12444 \xb7 webpack/webpack"))),(0,n.kt)("p",null,"And I finally found one superb solution:"),(0,n.kt)("img",{alt:"picture 4",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/js-howto-1641242384770-1735c971e0dc4c8544f7eec28eab5b84147af46e6063203370398c87a0ced622.png",width:"480"}),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",d({parentName:"li"},{href:"https://stackoverflow.com/questions/53801753/how-to-forbid-replacing-process-env-variables-during-compilation-in-webpack/69844926#69844926"}),"node.js - How to forbid replacing process.env variables during compilation in webpack? - Stack Overflow"))),(0,n.kt)("p",null,"So that:"),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-js"}),"// .erb/configs/webpack.config.main.prod.ts:75\n\n    new webpack.DefinePlugin({\n      VAR_ENV: 'process.env',\n    }),\n\n")),(0,n.kt)("p",null,"Then I can use like the following, in which I can change ",(0,n.kt)("inlineCode",{parentName:"p"},"process.env")," into ",(0,n.kt)("inlineCode",{parentName:"p"},"dbUrl"),", and passed the compile time check."),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-ts"}),"VAR_ENV.DATABASE_URL = dbUrl;\n")),(0,n.kt)("h2",d({},{id:"node-exec-sub-commands"}),"node exec sub commands"),(0,n.kt)("p",null,"I got to the conclusion that I should choose ",(0,n.kt)("inlineCode",{parentName:"p"},"exec")," instead of ",(0,n.kt)("inlineCode",{parentName:"p"},"execFile")," for a more universal use."),(0,n.kt)("p",null,"The core usage may be:"),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-js"}),"const {exec} = require('child_process');\nexec('cat *.js missing_file | wc -l', (error, stdout, stderr) => {\n  if (error) {\n    console.error(`exec error: ${error}`);\n    return;\n  }\n  console.log(`stdout: ${stdout}`);\n  console.error(`stderr: ${stderr}`);\n});\n")),(0,n.kt)("p",null,"ref:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://nodejs.org/api/child_process.html"}),"Child process | Node.js v17.3.0 Documentation"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/46445805/exec-vs-execfile-nodejs"}),"node.js - exec vs execFile nodeJs - Stack Overflow")))),(0,n.kt)("h2",d({},{id:"webpack"}),"webpack"),(0,n.kt)("p",null,"ref:"),(0,n.kt)("p",null,"A good article thoroughly talked about what's webpack and how to use it."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",d({parentName:"li"},{href:"https://blog.logrocket.com/transpile-es-modules-with-webpack-node-js/"}),"How to transpile ES modules with webpack and Node.js - LogRocket Blog"))),(0,n.kt)("h2",d({},{id:"receive-arg-from-command-line-standard-method-no-library"}),"receive arg from command line ","[Standard Method (no library)]"),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-sh"}),"# the first arg\nprocess.env.argv[2]\n")),(0,n.kt)("p",null,"The arguments are stored in ",(0,n.kt)("inlineCode",{parentName:"p"},"process.argv")),(0,n.kt)("p",null,"Here are the node docs on handling command line args:"),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"process.argv is an array containing the command line arguments. The first element will be 'node', the second element will be the name of the JavaScript file. The next elements will be any additional command line arguments.")),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-js"}),"// print process.argv\nprocess.argv.forEach(function (val, index, array) {\n  console.log(index + ': ' + val);\n});\n")),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-sh"}),"node process-2.js one two=three four\n")),(0,n.kt)("p",null,"This would generate:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"node"),(0,n.kt)("li",{parentName:"ol"},"/Users/mjr/work/node/process-2.js (the file)"),(0,n.kt)("li",{parentName:"ol"},"one (the first argv)"),(0,n.kt)("li",{parentName:"ol"},"two=three"),(0,n.kt)("li",{parentName:"ol"},"four")),(0,n.kt)("p",null,"ref:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",d({parentName:"li"},{href:"https://stackoverflow.com/questions/4351521/how-do-i-pass-command-line-arguments-to-a-node-js-program"}),"javascript - How do I pass command line arguments to a Node.js program? - Stack Overflow"))),(0,n.kt)("h2",d({},{id:"change-string-to-number-dont"}),"change string to number ","[DON'T]"),(0,n.kt)("p",null,"The discussion suggests me not to change a string to number."),(0,n.kt)("p",null,"ref:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/66052793/angular-typescript-convert-string-to-number"}),"Angular typescript convert string to number - Stack Overflow"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/33615680/how-to-properly-change-a-variables-type-in-typescript"}),"angular - How to properly change a variable's type in TypeScript? - Stack Overflow")))),(0,n.kt)("h2",d({},{id:"best-practice-to-use-exceptions"}),"best practice to use Exceptions"),(0,n.kt)("h3",d({},{id:"catch-error"}),"catch error"),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-js"}),"function handleError() {\n  try {\n    throw new RangeError();\n  } catch (e) {\n    switch (e.constructor) {\n      case Error:\n        return console.log('generic');\n      case RangeError:\n        return console.log('range');\n      default:\n        return console.log('unknown');\n    }\n  }\n}\n\nhandleError();\n")),(0,n.kt)("h3",d({},{id:"extend-error"}),"extend error"),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-js"}),"class MyError extends Error {\n  constructor(message) {\n    super(message);\n    this.name = 'MyError';\n  }\n}\n")),(0,n.kt)("p",null,"ref:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/23790509/proper-use-of-errors"}),"exception - Proper use of errors - Stack Overflow"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/1382107/whats-a-good-way-to-extend-error-in-javascript"}),"exception - What's a good way to extend Error in JavaScript? - Stack Overflow")))),(0,n.kt)("h2",d({},{id:"handbook-fs-read-file-async-and-part"}),"[HANDBOOK]"," fs read file, async and part"),(0,n.kt)("p",null,"TODO: From my point of view, the ",(0,n.kt)("inlineCode",{parentName:"p"},"fs.createReadStream")," is a ???"),(0,n.kt)("p",null,"ref:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise"}),"Promise - JavaScript | MDN"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/46867517/how-to-read-file-with-async-await-properly"}),"node.js - How to read file with async/await properly? - Stack Overflow"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/23720032/node-js-read-100-first-bytes-of-a-file"}),"javascript - node.js/ read 100 first bytes of a file - Stack Overflow"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/58431076/how-to-use-async-await-with-fs-createreadstream-in-node-js"}),"javascript - how to use async/await with fs.createReadStream in node js - Stack Overflow"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://www.runoob.com/nodejs/nodejs-stream.html"}),"Node.js Stream(\u6d41) | \u83dc\u9e1f\u6559\u7a0b"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/33445415/javascript-promises-reject-vs-throw"}),"JavaScript Promises - reject vs. throw - Stack Overflow"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/6456864/why-does-node-js-fs-readfile-return-a-buffer-instead-of-string"}),"javascript - Why does Node.js' fs.readFile() return a buffer instead of string? - Stack Overflow")))),(0,n.kt)("h2",d({},{id:"csv-read-and-parse"}),"csv read and parse"),(0,n.kt)("h3",d({},{id:"modify-header"}),"modify header"),(0,n.kt)("p",null,"buffer padding algorithm ",(0,n.kt)("a",d({parentName:"p"},{href:"https://gist.github.com/miguelmota/b296c10b68a91fa6041297a6778de81e"}),"Node.js buffer with padding (right justified fill) example")),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-js"}),"const buf = Buffer.alloc(32);\nconst a = Buffer.from('1234', 'hex');\na.copy(buf, buf.length - a.length);\nconsole.log(buf.toString('hex')); // 0000000000000000000000000000000000000000000000000000000000001234\n")),(0,n.kt)("p",null,"[fs.read]","(",(0,n.kt)("a",d({parentName:"p"},{href:"https://nodejs.org/api/fs.html#:~:text=subsequent%20read%20operations.-,fs.read,-(fd%2C%20buffer%2C%20offset)"}),"https://nodejs.org/api/fs.html#:~:text=subsequent%20read%20operations.-,fs.read,-(fd%2C%20buffer%2C%20offset)")),(0,n.kt)("p",null,"[fs.write]","(",(0,n.kt)("a",d({parentName:"p"},{href:"https://nodejs.org/api/fs.html#:~:text=its%20original%20name-,fs.write,-(fd%2C%20buffer%5B%2C%20offset)"}),"https://nodejs.org/api/fs.html#:~:text=its%20original%20name-,fs.write,-(fd%2C%20buffer%5B%2C%20offset)")),(0,n.kt)("p",null,"After I did a hard modification, a new problem arises from, i.e. ",(0,n.kt)("del",{parentName:"p"},"blank")," placeholder (update: it's ",(0,n.kt)("inlineCode",{parentName:"p"},"zero"),")."),(0,n.kt)("img",{alt:"picture 1",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/js-howto-1641750359863-e93a5d344bd4394c2e36f819acff8e5218a0041067c045bd39038dfa03cd2c40.png"}),(0,n.kt)("p",null,"And the solution is replacing there blanks, ref: ",(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/22809401/removing-a-null-character-from-a-string-in-javascript"}),"node.js - Removing a null character from a string in javascript - Stack Overflow")),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-ts"}),"// 1.\ns.replace(/\\0/g, '');\n\n// 2.\ns.replaceAll('\\0', '');\n")),(0,n.kt)("p",null,"Then I need to use this transform into ",(0,n.kt)("inlineCode",{parentName:"p"},"fast-csv"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-ts"}),"// src/main/modules/parseFile/center.ts:78\n    .pipe(\n      csv.parse({\n        headers: (headers) => headers.map((h) => h?.replace(/\\0/g, '')),\n      })\n    ) // PR: header true/false; ref: https://stackoverflow.com/a/22809513/9422455\n")),(0,n.kt)("p",null,"However, I thought this a little not elegant, so I came up a new idea:"),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-ts"}),"// src/main/modules/parseFile/handler/checkCsvEncoding.ts:85\nconst bufToWrite = Buffer.alloc(L);\nconst tempBuf = iconv.encode(s, encoding);\nconst offset = L - tempBuf.length;\ntempBuf.copy(bufToWrite, offset);\nfs.write(fd, bufToWrite, 0, L, 0, (err) => {\n  // prettier-ignore\n  return !err? resolve({\n    useIconv: encoding === ValidEncoding.gbk, \n    offset\n    }) : reject(new GenericError(errorModifyingHeader, `replace error: ${err}, string: ${s}, bufToWrite: ${bufToWrite}`));\n});\n")),(0,n.kt)("p",null,"I saved the offset, so that when I open this file again, I can use this offset quickly located the real start without ",(0,n.kt)("inlineCode",{parentName:"p"},"\\0"),"."),(0,n.kt)("p",null,"And it did work!"),(0,n.kt)("h4",d({},{id:"then-what-about-repeatability"}),"then, what about repeatability?"),(0,n.kt)("p",null,"After a battle of mind, I gave up with the wonderful write back idea, since it would destroy the raw data and inflexible or costly to re-use the sheet."),(0,n.kt)("p",null,"I then do not modify the data, but to use header map:"),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-ts"}),"// src/main/modules/parseFile/center.ts:72\nconst progress = new ParsingProgress();\nconst headers = (headers) =>\n  headers.map((header) => (header === SIGNAL_ID ? COL_ID : header));\n\ns2.pipe(\n  new SizeTransformer(fs.statSync(fp).size, (pct) =>\n    progress.updateSizePct(pct),\n  ),\n).pipe(csv.parse({headers})); // PR: header true/false; ref: https://stackoverflow.com/a/22809513/**9422455**\n")),(0,n.kt)("h3",d({},{id:"node-csv-or-fast-csv"}),(0,n.kt)("inlineCode",{parentName:"h3"},"node-csv")," or ",(0,n.kt)("inlineCode",{parentName:"h3"},"fast-csv")),(0,n.kt)("p",null,"First, I chose ",(0,n.kt)("inlineCode",{parentName:"p"},"csv")," since its star is more than ",(0,n.kt)("inlineCode",{parentName:"p"},"fast-csv"),"'s."),(0,n.kt)("img",{alt:"picture 71",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/1640635030511-csv-d2df9d938bfadf6af66e0e1d9fe1a5dee37891c7455eedbe84f048ff4227f119.png",width:"480"}),(0,n.kt)("p",null,"However, I soon happened to find it's too raw to chinese file parse, since the ",(0,n.kt)("inlineCode",{parentName:"p"},"csv")," can't handle the ",(0,n.kt)("inlineCode",{parentName:"p"},"gbk")," problem, at least, not automatically. ",(0,n.kt)("img",{alt:"picture 73",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/1640638212636-csv-a8397a9973387672ab6bbf9feee651be1d97a47c9e8a255b125ea62feb613329.png",width:"480"})),(0,n.kt)("p",null,"And the behind reason is that the ",(0,n.kt)("inlineCode",{parentName:"p"},"fs.createReadStream")," doesn't support our ",(0,n.kt)("inlineCode",{parentName:"p"},"gbk")," format. ",(0,n.kt)("img",{alt:"picture 72",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/1640638161109-csv-208716b9781a4ed34babbb56fef9cf4c214377689e850fc35c14b5b5c0d4ab5a.png",width:"480"})),(0,n.kt)("p",null,"As a contrast, the ",(0,n.kt)("inlineCode",{parentName:"p"},"fast-csv")," helped me a lot."),(0,n.kt)("p",null,"If I just use ",(0,n.kt)("inlineCode",{parentName:"p"},"fast-csv")," to read ",(0,n.kt)("inlineCode",{parentName:"p"},"gbk")," file, then the default garbled(\u4e71\u7801) would be shown(but not error), which would output correctly if we added the pipe of ",(0,n.kt)("inlineCode",{parentName:"p"},"iconv")," conversion."),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-ts"}),"import * as csv from '@fast-csv/parse';\nimport * as fs from 'fs';\nimport iconv from 'iconv-lite';\n\nfs.createReadStream('./samples/erp_md.csv')\n  .pipe(iconv.decodeStream('gbk'))\n  .pipe(iconv.encodeStream('utf-8'))\n  .pipe(csv.parse({headers: true}))\n  .on('error', (error) => console.error(error))\n  .on('data', (row) => console.log(row))\n  .on('end', (rowCount: number) => console.log(`Parsed ${rowCount} rows`));\n")),(0,n.kt)("p",null,"In conclusion, maybe I don't know whether the speed when handling data of ",(0,n.kt)("inlineCode",{parentName:"p"},"fast-csv")," is faster than the ",(0,n.kt)("inlineCode",{parentName:"p"},"node-csv"),", but it does free me a lot from annoying encoding problems, which is also ",(0,n.kt)("inlineCode",{parentName:"p"},"fast"),"!"),(0,n.kt)("p",null,"I then would not hesitate to choose ",(0,n.kt)("inlineCode",{parentName:"p"},"fast-csv"),"."),(0,n.kt)("p",null,"ref:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://github.com/adaltas/node-csv"}),"adaltas/node-csv: Full featured CSV parser with simple api and tested against large datasets."))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://csv.js.org/"}),"CSV Project - Node.js CSV package"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://www.npmtrends.com/csv-parse-vs-fast-csv-vs-node-csv"}),"csv-parse vs fast-csv vs node-csv | npm trends"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/23080413/parsing-a-csv-file-using-nodejs"}),"node.js - Parsing a CSV file using NodeJS - Stack Overflow"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://www.npmtrends.com/csv-parse-vs-fast-csv-vs-node-csv"}),"csv-parse vs fast-csv vs node-csv | npm trends"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://stackoverflow.com/questions/23080413/parsing-a-csv-file-using-nodejs"}),"node.js - Parsing a CSV file using NodeJS - Stack Overflow"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://brickyang.github.io/2018/03/10/Node-js-%E8%A7%A3%E5%86%B3-csv-%E6%96%87%E4%BB%B6%E4%B9%B1%E7%A0%81%E7%9A%84%E4%B8%A4%E7%A7%8D%E5%8A%9E%E6%B3%95/"}),"Node.js \u89e3\u51b3 csv \u6587\u4ef6\u4e71\u7801\u7684\u4e24\u79cd\u529e\u6cd5 | \u5168\u6808\u6e10\u8fdb\u4e4b\u8def")))),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"iconv"),"\u89e3\u7801",(0,n.kt)("inlineCode",{parentName:"p"},"gbk"),"\u5fc5\u5907\uff01"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://www.npmjs.com/package/iconv-lite"}),"iconv-lite - npm"))),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("a",d({parentName:"p"},{href:"https://blog.csdn.net/CaanDoll/article/details/84639668"}),"(20 \u6761\u6d88\u606f) nodejs \u8bfb\u53d6 csv \u4e2d\u6587\u4e71\u7801","_","CaanDoll \u7684\u535a\u5ba2-CSDN \u535a\u5ba2")))),(0,n.kt)("h3",d({},{id:"fast-csv-problem-of-quotes"}),(0,n.kt)("inlineCode",{parentName:"h3"},"fast-csv")," problem of quotes"),(0,n.kt)("p",null,"ref:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",d({parentName:"li"},{href:"https://c2fo.github.io/fast-csv/docs/introduction/getting-started"}),"Getting Started | Fast-CSV"))),(0,n.kt)("h3",d({},{id:"csv-not-closed"}),"csv not closed"),(0,n.kt)("p",null,"I did test, and to find that the stream is destroyed but not closed, since read by block but parse by row."),(0,n.kt)("img",{alt:"picture 34",src:"https://mark-vue-oss.oss-cn-hangzhou.aliyuncs.com/js-howto-1641589088462-aef98f82fa7119db7eff3535c4bbedf1b331c90e65ea4b9fda1618b53dc1b47c.png"}),(0,n.kt)("p",null,"So the better way is to detect header first."),(0,n.kt)("h2",d({},{id:"run-js-in-different-envs"}),"run js in different envs"),(0,n.kt)("h3",d({},{id:"browser-env"}),"browser env"),(0,n.kt)("p",null,"just open the chrome, and the console of it."),(0,n.kt)("h3",d({},{id:"node-env"}),"node env"),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-sh"}),"node .\n")),(0,n.kt)("h3",d({},{id:"node--esm"}),"node + esm"),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-sh"}),"node --experimental-modules .\n")),(0,n.kt)("p",null,"And then, in the console, use dynamic import like this: ",(0,n.kt)("inlineCode",{parentName:"p"},'var s; import("XXX").then(r => s.default)'),"."),(0,n.kt)("p",null,"!!!warning javascript doesn't support ",(0,n.kt)("inlineCode",{parentName:"p"},"esm")),(0,n.kt)("p",null,"ref:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",d({parentName:"li"},{href:"https://github.com/nodejs/node/issues/19570"}),"dynamic import can't be used in the REPL \xb7 Issue #19570 \xb7 nodejs/node"))),(0,n.kt)("h3",d({},{id:"node--esm--ts"}),"node + esm + ts"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"install ",(0,n.kt)("inlineCode",{parentName:"li"},"ts-node"))),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-sh"}),"npm i -D ts-node\ntsc --init\n")),(0,n.kt)("ol",d({},{start:2}),(0,n.kt)("li",{parentName:"ol"},"modify ",(0,n.kt)("inlineCode",{parentName:"li"},"tsconfig.json")," file")),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-json"}),'// tsconfig.json\n{\n  "module": "esnext" /* Specify what module code is generated. */,\n  "modulesolution": "node" /* Specify how TypeScript looks up a file from a given module specifier. */,\n  "esModuleInterop": true /* Emit additional JavaScript to ease support for importing CommonJS modules. This enables `allowSyntheticDefaultImports` for type compatibility. */\n}\n')),(0,n.kt)("ol",d({},{start:3}),(0,n.kt)("li",{parentName:"ol"},"run ",(0,n.kt)("inlineCode",{parentName:"li"},"node --loader ts-node/esm FILE")," instead of ",(0,n.kt)("inlineCode",{parentName:"li"},"ts-node FILE"))),(0,n.kt)("p",null,"ref:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",d({parentName:"li"},{href:"https://stackoverflow.com/questions/62096269/cant-run-my-node-js-typescript-project-typeerror-err-unknown-file-extension"}),'Can\'t run my Node.js Typescript project TypeError [ERR_UNKNOWN_FILE_EXTENSION]: Unknown file extension ".ts" for /app/src/App.ts - Stack Overflow'))),(0,n.kt)("h2",d({},{id:"use-__filename-and-__dirname-in-esm"}),"use ",(0,n.kt)("inlineCode",{parentName:"h2"},"__filename")," and ",(0,n.kt)("inlineCode",{parentName:"h2"},"__dirname")," in ESM"),(0,n.kt)("pre",null,(0,n.kt)("code",d({parentName:"pre"},{className:"language-js"}),"import {dirname} from 'path';\nimport {fileURLToPath} from 'url';\n\nconst __dirname = dirname(fileURLToPath(import.meta.url));\n")),(0,n.kt)("p",null,"ref:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",d({parentName:"li"},{href:"https://stackoverflow.com/questions/46745014/alternative-for-dirname-in-node-js-when-using-es6-modules"}),"ecmascript 6 - Alternative for ","_","_","dirname in Node.js when using ES6 modules - Stack Overflow"))))}v.isMDXComponent=!0}}]);